---
title: "Beyond Traditional Boxplot: The Adjusted and Generalized Boxplots"
description: "Boxplots, also known as box-and-whisker plots, have been a cornerstone of data visualization since their introduction by John Tukey in the 1970s. Despite their enduring utility, boxplot assumes a symmetric distribution and might misrepresent datasets with skewness or heavy tails. Alternative approaches have been proposed to address these limitations."
author: "Christian L. Goueguel"
date: "11/20/2023"
image: "cover.png"
categories:
  - Preprocessing
  - Chemometrics
  - Machine Learning
  - Outliers
  - Data Visualization
---

::: justified
![Photo by [Dana Katharina](https://unsplash.com/photos/a-view-of-a-mountain-range-from-a-grassy-field-90J_cdOKTeo?utm_content=creditShareLink&utm_medium=referral&utm_source=unsplash).](cover.png){fig-align="center" width="1500"}

## Tukey's Boxplot

Proposed by Tukey in 1977 \[1\], a boxplot is constructed using five key summary statistics: the minimum, first quartile (Q1), median, third quartile (Q3), and maximum. These elements are complemented by whiskers, which typically extend to 1.5 times the interquartile range (IQR = Q3 - Q1) beyond Q1 and Q3, respectively. Data points outside this range are flagged as potential outliers. The ends of the whiskers are called adjacent values. They are the smallest and largest values not flagged outliers. Because the interquartile range has a finite sample breakdown point of 0.25, it takes more than 25% of the data to be outliers before the problem of masking occurs. For example, Fig.1 shows how the quartiles and therefore IQR are significantly influenced by the outliers, highlighting the breakdown point. After replacing 25% of the data with extreme outliers, the IQR increased drastically, from 13 (clean data) to 136 (contaminated data). This demonstrates that with 25% contamination, the IQR becomes unreliable as a measure of spread.

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
set.seed(42)

data_clean <- rnorm(100, mean = 50, sd = 10)
n_outliers <- floor(length(data_clean) * 0.25)
data_contaminated <- data_clean
data_contaminated[1:n_outliers] <- runif(n_outliers, min = 500, max = 1000)

data <- tibble(
  Value = c(data_clean, data_contaminated),
  Dataset = rep(
    c("Clean Data", "Contaminated Data\n(25% Outliers)"), 
    each = length(data_clean)
    )
  )

summary_stats <- data %>%
  group_by(Dataset) %>%
  summarise(
    Q1 = quantile(Value, 0.25),
    Q3 = quantile(Value, 0.75),
    IQR = Q3 - Q1
  )

ggplot(data, aes(x = Value, y = Dataset, fill = Dataset)) +
  geom_boxplot(
    outlier.shape = 21, 
    outlier.size = 2, 
    outlier.alpha = 0.85,
    width = .3,
    staplewidth = 0.5) +
  geom_vline(
    data = summary_stats, 
    aes(xintercept = Q1, color = Dataset), 
    linetype = "dashed") +
  geom_vline(
    data = summary_stats, 
    aes(xintercept = Q3, color = Dataset), 
    linetype = "dashed") +
  scale_fill_manual(values = c("skyblue", "lightcoral")) +
  scale_color_manual(values = c("orange", "green")) +
  labs(
    x = "", y = "",
    caption = "Fig.1: The interquartile range (IQR) has a finite sample breakdown point of 0.25.") +
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~Dataset, nrow = 2, ncol = 1, scales = "free") +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    panel.grid = element_blank()
  )
```

While boxplot is a widely used tool for visualizing data distributions, especially when those distributions are symmetric. However, its effectiveness diminishes when dealing with skewed data. In such cases, the boxplot can misrepresent the dataset's nuances—most notably by classifying an excessive number of larger values as outliers when the distribution is skewed to the right. Recognizing this limitation, Hubert and Vandervieren \[2\] introduced a refined version of Tukey's boxplot rule. Their approach incorporates a robust measure of skewness, allowing for a more accurate depiction of asymmetrical distributions while preserving the simplicity and interpretability of the Tukey's boxplot.

## The Adjusted Boxplot

In 2004, Brys *et al*. \[3\] introduced the Medcouple (MC), which is a robust statistic used to measure the skewness of a distribution. Unlike traditional measures of skewness that are sensitive to outliers, MC focuses on the median and the IQR, making it less affected by extreme values. It is based on the difference between left and right data spreads relative to the median. MC is bounded between −1 and 1. A value of 0 indicates a perfectly symmetric distribution, while positive values signify a right-tailed (positively skewed) distribution, and negative values correspond to a left-tailed (negatively skewed) distribution. Importantly, this measure is most effective for moderately skewed distributions, particularly when the absolute value of MC is less than or equal to 0.6 ($|\text{MC}| \leq 0.6$). MC is given by:

$$
\text{MC} = \text{med} \left\{ \frac{(x_i - m) - (m - x_j)}{x_i - x_j} \, \middle| \, x_i \geq m \geq x_j \right\}
$$

where, $x_i$ and $x_j$ are data points from the sample, $m$ is the median of the sample, and $\text{med}\{\cdot\}$ denotes the median operator.

To address the limitation of the Tukey's boxplot in handling skewed data, Hubert and Vandervieren \[2\] introduced the adjusted boxplot for skewed distribution. This method modifies the whisker length based on the MC. Specifically, the upper whisker extends further for right-skewed data, and the lower whisker extends further for left-skewed data. This new approch modifies the traditional boxplot fences to account for skewness in the data using the exponential function of MC as follows:

$$
\begin{aligned}
    \text{Lower Fence} &= Q_1 - k \cdot e^{-\text{MC}} \cdot \text{IQR} \\
    \text{Upper Fence} &= Q_3 + k \cdot e^{\text{MC}} \cdot \text{IQR}
\end{aligned}
$$

where, $k$ is the fence factor. The adjusted boxplot is optimized for $k = 1.5$.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Load required libraries
library(tidyverse)
library(robustbase)  # For Medcouple calculation

# Generate right-skewed data
#set.seed(123)
skewed_data <- data.frame(y = rgamma(200, shape = 2, scale = 2))

# Add 10 extreme outliers (large values)
# outliers <- data.frame(y = rnorm(10, mean = 50, sd = 10))  # Extreme outliers
# skewed_data <- bind_rows(skewed_data, outliers)

# Function to calculate adjusted boxplot fences
# adjusted_fences <- function(data, k = 1.5) {
#   Q1 <- quantile(data, 0.25)
#   Q3 <- quantile(data, 0.75)
#   IQR <- Q3 - Q1
#   MC <- mc(data)  # Calculate Medcouple
#   
#   lower_fence <- Q1 - k * exp(-MC) * IQR
#   upper_fence <- Q3 + k * exp(MC) * IQR
#   
#   c(lower_fence, upper_fence)
# }

# Function to add fences to the dataset
add_boxplot_type <- function(data, type) {
  if (type == "Tukey's Boxplot") {
    Q1 <- quantile(data$y, 0.25)
    Q3 <- quantile(data$y, 0.75)
    IQR <- Q3 - Q1
    lower_fence <- Q1 - 1.5 * IQR
    upper_fence <- Q3 + 1.5 * IQR
  } else if (type == "Adjusted Boxplot") {
    fences <- specProc::adjusted_boxplot(data$y, plot = FALSE)
    lower_fence <- fences$stats$q1
    upper_fence <- fences$stats$q3
  }
  
  data %>%
    mutate(
      method = type,
      outlier = ifelse(y < lower_fence | y > upper_fence, TRUE, FALSE)
    )
}

# Add Tukey's and adjusted boxplot data
tukey_data <- add_boxplot_type(skewed_data, "Tukey's Boxplot")
adjusted_data <- add_boxplot_type(skewed_data, "Adjusted Boxplot")

# Combine both datasets
combined_data <- bind_rows(tukey_data, adjusted_data)

# Create the plot
ggplot(combined_data, aes(x = method, y = y, fill = method)) +
  geom_boxplot(
    width = .3,
    staplewidth = 0.5,
    outlier.shape = NA, 
    alpha = 0.7
    ) +
  geom_jitter(aes(color = outlier), width = 0.2, alpha = 0.3) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    #title = "Comparison of Tukey's Boxplot and Adjusted Boxplot",
    #subtitle = "Adjusted boxplot accounts for skewness using Medcouple",
    x = NULL,
    y = NULL,
    color = "Outlier"
  ) +
  coord_flip() +
  theme_bw(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0),
    plot.subtitle = element_text(hjust = 0),
    legend.position = "none"
  )
```

## The Generalized Boxplot

There is, however, a feature of this adjusted boxplot rule that should be mentioned. Imagine a distribution that is skewed to the right. Among the larger values, the adjusted boxplot rule might declare fewer points outliers, as intended, but among the lower values, it might declare points outliers that are not flagged as outliers by the boxplot rule. Bruffaerts et al. (2014) raise other concerns about this outlier detection method and suggest a more involved approach. The method suggested by Walker et al. (2018) suffers from similar problems.
:::
